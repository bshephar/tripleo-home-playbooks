- block:
  - copy:
      content: "#!/bin/sh\ntmpwatch --nodirs \\\n  -X \"/var/log/containers/*/*log\"\
        \ \\\n  -X \"/var/log/containers/*/*/*log\" \\\n  -X \"/var/log/containers/*/*err\"\
        \ \\\n  {{ LogrotatePurgeAfterDays|int +1 }}d \\\n  /var/log/containers/ 2>&1\
        \ | logger -t container-tmpwatch\n"
      dest: /usr/local/sbin/containers-tmpwatch
      group: root
      mode: 493
      owner: root
    name: Push script
    vars:
      LogrotatePurgeAfterDays: '14'
  - cron:
      job: /usr/local/sbin/containers-tmpwatch
      name: Remove old logs
      special_time: daily
      user: root
    name: Insert cronjob in root crontab
  name: configure tmpwatch on the host
  when: step|int == 2
- block:
  - failed_when: ( ( "self signed certificate" not in openssl_output.stderr ) and
      ( "OK" not in openssl_output.stdout ) ) or ("expired" in openssl_output.stderr)
    name: Verify SSL certificate
    register: openssl_output
    shell: 'cat << EOF | openssl verify

      {{ssl_cert}}

      EOF

      '
    when:
    - ( ssl_cert | length ) > 512
    - protocol == "https"
  - fail:
      msg: 'SSLCertificate is empty or too short and PublicSSLCertificateAutogenerated
        is False and at least one endpoint is configured with https

        '
    when:
    - ( ssl_cert | length ) < 512
    - not ( auto_gen | bool )
    - protocol == "https"
  name: Validate SSLCertificate is properly defined if PublicSSLCertificateAutogenerated
    is False
  vars:
    auto_gen: false
    protocol: https
    ssl_cert: "-----BEGIN CERTIFICATE-----\nMIIEBjCCAu6gAwIBAgIUD9dWy9NTo7VdQIVgWrskiCtqzxcwDQYJKoZIhvcNAQEL\n\
      BQAwXTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClF1ZWVuc2xhbmQxETAPBgNVBAcM\nCEJyaXNiYW5lMREwDwYDVQQKDAhibmUtaG9tZTETMBEGA1UEAwwKVHJpcGxlTyBD\n\
      QTAeFw0yMjAzMzAwNDIwNDVaFw0yMzA4MTIwNDIwNDVaMIGdMQswCQYDVQQGEwJB\nVTETMBEGA1UECAwKUXVlZW5zbGFuZDERMA8GA1UEBwwIQnJpc2JhbmUxETAPBgNV\n\
      BAoMCHlvdXItb3JnMQ4wDAYDVQQLDAVhZG1pbjEiMCAGCSqGSIb3DQEJARYTYnNo\nZXBoYXJAcmVkaGF0LmNvbTEfMB0GA1UEAwwWb3BlbnN0YWNrLmJuZS1ob21lLm5l\n\
      dDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMdykKsu74rVca3fc0uw\n/l9CtKjdQBtutnPFUgMqeqI70pP4ap/13BjqjKCo9teheyhZlkzDUfd6UAwIBFqW\n\
      rZt+Dd2PfuS/MtUyw1kvdYmh7Lpaqi4XBcORFty/jBnO7NucpkyvszwNNs0W+H8g\nZ1JMUzdJ8UtNlMZT86cQ15YSTjye0S/ntZGOHbiMPoGeQOXzP+vz8hXKscY+w7uv\n\
      Px9HsLgdmXFipZ1smbgGm5vubtlSI3fNoLFI92AMGiPLSdF48GS7ydVOGh6BMzdg\nGozrlyia/v7gnKEvDvmzIp/eAb6ZUv4ThMmwpi4mR7BqxXNZ/IitTd4ppm+0IRcC\n\
      q70CAwEAAaN9MHswHwYDVR0jBBgwFoAUD99iTxSeV1pImIWdV/nBRD8jJ2EwCQYD\nVR0TBAIwADALBgNVHQ8EBAMCBPAwIQYDVR0RBBowGIIWb3BlbnN0YWNrLmJuZS1o\n\
      b21lLm5ldDAdBgNVHQ4EFgQUq5b3jd2e+Nj5qWO/2lCOM9TZRb0wDQYJKoZIhvcN\nAQELBQADggEBAJzmJRDSEllG+2pA/QD73mbde79G6BcIhOxOLsCzG6bqYKWtEgEJ\n\
      kGu6EsHlkN6TMFiwME8dZu5yGJZQ8hZxg6yXjJfgUQB23w6zxcLGE5W93h0bYrvI\ntHDiFELe+NtlOqJ38TYCfi6Or3l0Yh8ZzZSXrk39D0L619hcVPb8T6niM2f7pG76\n\
      2DRsU0A+56iQIxZZhUPh7jbiDy/NePqf1dCRnoR3423qq8sEW/jnCKWs2dq0RWD6\n+i1ULnJfTAvSSpET1jd/FJ3VTaa2441j5MneOxrptEayx92UaZZ+gbwEyr62nq4M\n\
      EHP8xqG4qn7lz0BpsFbBb+ZyCVcG6Zyt5xM=\n-----END CERTIFICATE-----  \n"
  when:
  - true
  - step|int == 2
- block:
  - import_role:
      name: tripleo_ha_wrapper
    name: HAproxy puppet bundle
    vars:
      tripleo_ha_wrapper_bundle_name: haproxy-bundle
      tripleo_ha_wrapper_puppet_config_volume: haproxy
      tripleo_ha_wrapper_puppet_debug: false
      tripleo_ha_wrapper_puppet_execute: include ::tripleo::profile::base::pacemaker;
        include ::tripleo::profile::pacemaker::haproxy_bundle
      tripleo_ha_wrapper_puppet_tags: pacemaker::resource::bundle,pacemaker::property,pacemaker::resource::ip,pacemaker::resource::ocf,pacemaker::constraint::order,pacemaker::constraint::colocation
      tripleo_ha_wrapper_resource_name: haproxy-bundle
      tripleo_ha_wrapper_resource_state: Started
      tripleo_ha_wrapper_service_name: haproxy
  name: HAproxy HA Wrappers Step
  when: step|int == 2
- include_role:
    name: tripleo_iscsid
    tasks_from: configure.yml
  name: Configure iscsid
- block:
  - import_role:
      name: tripleo_ha_wrapper
    name: Mysql puppet bundle
    vars:
      tripleo_ha_wrapper_bundle_name: galera-bundle
      tripleo_ha_wrapper_puppet_config_volume: mysql
      tripleo_ha_wrapper_puppet_debug: false
      tripleo_ha_wrapper_puppet_execute: '["Mysql_datadir", "Mysql_user", "Mysql_database",
        "Mysql_grant", "Mysql_plugin"].each |String $val| { noop_resource($val) };
        include ::tripleo::profile::base::pacemaker; include ::tripleo::profile::pacemaker::database::mysql_bundle'
      tripleo_ha_wrapper_puppet_tags: pacemaker::resource::bundle,pacemaker::property,pacemaker::resource::ocf,pacemaker::constraint::order,pacemaker::constraint::colocation
      tripleo_ha_wrapper_resource_name: galera
      tripleo_ha_wrapper_resource_state: Master
      tripleo_ha_wrapper_service_name: mysql
  name: MySQL HA Wrappers Step
  when: step|int == 2
- block:
  - import_role:
      name: tripleo_ha_wrapper
    name: Rabbitmq rpc puppet bundle
    vars:
      tripleo_ha_wrapper_bundle_name: rabbitmq-bundle
      tripleo_ha_wrapper_puppet_config_volume: rabbitmq
      tripleo_ha_wrapper_puppet_debug: false
      tripleo_ha_wrapper_puppet_execute: '["Rabbitmq_policy", "Rabbitmq_user"].each
        |String $val| { noop_resource($val) }; include ::tripleo::profile::base::pacemaker;
        include ::tripleo::profile::pacemaker::rabbitmq_bundle'
      tripleo_ha_wrapper_puppet_tags: pacemaker::resource::bundle,pacemaker::property,pacemaker::resource::ip,pacemaker::resource::ocf,pacemaker::constraint::order,pacemaker::constraint::colocation
      tripleo_ha_wrapper_resource_name: rabbitmq
      tripleo_ha_wrapper_resource_state: Started
      tripleo_ha_wrapper_service_name: oslo_messaging_rpc
  name: RabbitMQ RPC HA Wrappers Step
  when: step|int == 2
