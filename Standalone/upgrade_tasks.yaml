- block:
  - failed_when: false
    name: Get cinder_volume image id currently used by pacemaker
    register: cinder_volume_image_current_res
    shell: pcs resource config openstack-cinder-volume | grep -Eo 'image=[^ ]+' |
      awk -F= '{print $2;}'
  - name: cinder_volume image facts
    set_fact:
      cinder_volume_image_current: '{{cinder_volume_image_current_res.stdout}}'
      cinder_volume_image_latest: quay.io/tripleomastercentos9/openstack-cinder-volume:pcmklatest
  - import_role:
      name: tripleo_container_tag
    name: Temporarily tag the current cinder_volume image id with the upgraded image
      name
    vars:
      container_image: '{{cinder_volume_image_current}}'
      container_image_latest: '{{cinder_volume_image_latest}}'
      pull_image: false
    when:
    - cinder_volume_image_current != ''
    - cinder_volume_image_current != cinder_volume_image_latest
  - changed_when: false
    failed_when: false
    name: Check openstack-cinder-volume cluster resource status
    register: cinder_volume_pcs_res_result
    shell: pcs resource config openstack-cinder-volume
  - name: Set fact cinder_volume_pcs_res
    set_fact:
      cinder_volume_pcs_res: '{{cinder_volume_pcs_res_result.rc == 0}}'
  - name: set is_cinder_volume_bootstrap_node fact
    set_fact: is_cinder_volume_bootstrap_node={{cinder_volume_short_bootstrap_node_name|lower
      == ansible_facts['hostname']|lower}}
    tags: common
  name: Prepare switch of cinder_volume image name
  when:
  - step|int == 0
- block:
  - name: Disable the cinder_volume cluster resource before container upgrade
    pacemaker_resource:
      resource: openstack-cinder-volume
      state: disable
      wait_for_resource: true
    register: output
    retries: 5
    until: output.rc == 0
  - command: pcs resource bundle update openstack-cinder-volume container image={{cinder_volume_image_latest}}
    name: pcs resource bundle update cinder_volume for new container image name
  - name: Enable the cinder_volume cluster resource
    pacemaker_resource:
      resource: openstack-cinder-volume
      state: enable
      wait_for_resource: true
    register: output
    retries: 5
    until: output.rc == 0
  name: Update cinder_volume pcs resource bundle for new container image
  when:
  - step|int == 1
  - is_cinder_volume_bootstrap_node
  - cinder_volume_pcs_res|bool
  - cinder_volume_image_current != cinder_volume_image_latest
- block:
  - name: set cinder_volume upgrade node facts in a single-node environment
    set_fact:
      cacheable: false
      cinder_volume_node_names_upgraded: '{{ cinder_volume_node_names | default([])
        }}'
      cinder_volume_short_node_names_upgraded: '{{ cinder_volume_short_node_names
        }}'
    when: groups['cinder_volume'] | length <= 1
  - loop: '{{ cinder_volume_node_names | default([]) }}'
    name: set cinder_volume upgrade node facts from the limit option
    set_fact:
      cacheable: false
      cinder_volume_node_names_upgraded: '{{ cinder_volume_node_names_upgraded|default([])
        + [item] }}'
      cinder_volume_short_node_names_upgraded: '{{ cinder_volume_short_node_names_upgraded|default([])
        + [item.split(''.'')[0]] }}'
    when:
    - groups['cinder_volume'] | length > 1
    - item.split('.')[0] in ansible_limit.split(':')
  - fail:
      msg: 'You can''t upgrade cinder_volume without staged upgrade.  You need to
        use the limit option in order to do so.

        '
    when: cinder_volume_short_node_names_upgraded is not defined or cinder_volume_short_node_names_upgraded
      | length == 0 or cinder_volume_node_names_upgraded is not defined or cinder_volume_node_names_upgraded
      | length == 0
  - debug:
      msg: Prepare cinder_volume upgrade for {{ cinder_volume_short_node_names_upgraded
        }}
  - include_role:
      name: tripleo_container_rm
    name: remove cinder_volume init container on upgrade-scaleup to force re-init
    vars:
      tripleo_containers_to_rm:
      - cinder_volume_init_bundle
    when:
    - cinder_volume_short_node_names_upgraded | length > 1
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: set.yml
    name: add the cinder_volume short name to hiera data for the upgrade.
    vars:
      tripleo_upgrade_key: cinder_volume_short_node_names_override
      tripleo_upgrade_value: '{{ cinder_volume_short_node_names_upgraded }}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: set.yml
    name: add the cinder_volume long name to hiera data for the upgrade
    vars:
      tripleo_upgrade_key: cinder_volume_node_names_override
      tripleo_upgrade_value: '{{ cinder_volume_node_names_upgraded }}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: remove.yml
    loop:
    - cinder_volume_short_node_names_override
    - cinder_volume_node_names_override
    name: remove the extra hiera data needed for the upgrade.
    vars:
      tripleo_upgrade_key: '{{ item }}'
    when: cinder_volume_short_node_names_upgraded | length == cinder_volume_node_names
      | length
  name: Create hiera data to upgrade cinder_volume in a stepwise manner.
  when:
  - step|int == 1
  - cluster_recreate|bool
- block:
  - name: Get container cinder_volume image
    set_fact:
      cinder_volume_image: quay.io/tripleomastercentos9/openstack-cinder-volume:current-tripleo
      cinder_volume_image_latest: quay.io/tripleomastercentos9/openstack-cinder-volume:pcmklatest
  - command: '{{container_cli}} pull {{cinder_volume_image}}'
    delay: 3
    name: Pull latest cinder_volume images
    register: result
    retries: 3
    until: result.rc == 0
  - failed_when: false
    name: Get previous cinder_volume image id
    register: old_cinder_volume_image_id
    shell: '{{container_cli}} inspect --format ''{{''{{''}}.Id{{''}}''}}'' {{cinder_volume_image_latest}}'
  - name: Get new cinder_volume image id
    register: new_cinder_volume_image_id
    shell: '{{container_cli}} inspect --format ''{{''{{''}}.Id{{''}}''}}'' {{cinder_volume_image}}'
  - include_role:
      name: tripleo_container_tag
    name: Retag pcmklatest to latest cinder_volume image
    vars:
      container_image: '{{cinder_volume_image}}'
      container_image_latest: '{{cinder_volume_image_latest}}'
    when:
    - old_cinder_volume_image_id.stdout != new_cinder_volume_image_id.stdout
  name: Retag the pacemaker image if containerized
  when:
  - step|int == 3
- file:
    path: /etc/cron.daily/containers-tmpwatch
    state: absent
  name: Ensure old cron.daily is absent
  when: step|int == 1
- block:
  - failed_when: false
    name: Get haproxy image id currently used by pacemaker
    register: haproxy_image_current_res
    shell: pcs resource config haproxy-bundle | grep -Eo 'image=[^ ]+' | awk -F= '{print
      $2;}'
  - name: Image facts for haproxy
    set_fact:
      haproxy_image_current: '{{haproxy_image_current_res.stdout}}'
      haproxy_image_latest: quay.io/tripleomastercentos9/openstack-haproxy:pcmklatest
  - import_role:
      name: tripleo_container_tag
    name: Temporarily tag the current haproxy image id with the upgraded image name
    vars:
      container_image: '{{haproxy_image_current}}'
      container_image_latest: '{{haproxy_image_latest}}'
      pull_image: false
    when:
    - haproxy_image_current != ''
    - haproxy_image_current != haproxy_image_latest
  - changed_when: false
    failed_when: false
    name: Check haproxy cluster resource status
    register: haproxy_pcs_res_result
    shell: pcs resource config haproxy-bundle
  - name: Set upgrade haproxy facts
    set_fact:
      haproxy_pcs_res: '{{haproxy_pcs_res_result.rc == 0}}'
      is_haproxy_bootstrap_node: '{{haproxy_short_bootstrap_node_name|lower == ansible_facts[''hostname'']|lower}}'
  name: Prepare switch of haproxy image name
  when:
  - step|int == 0
- block:
  - name: Disable the haproxy cluster resource before container upgrade
    pacemaker_resource:
      resource: haproxy-bundle
      state: disable
      wait_for_resource: true
    register: output
    retries: 5
    until: output.rc == 0
  - block:
    - command: cibadmin --query --xpath "//storage-mapping[@id='haproxy-var-lib']"
      failed_when: false
      name: Check haproxy stats socket configuration in pacemaker
      register: haproxy_stats_exposed
    - command: cibadmin --query --xpath "//storage-mapping[@id='haproxy-cert']"
      failed_when: false
      name: Check haproxy public certificate configuration in pacemaker
      register: haproxy_cert_mounted
    - command: pcs resource bundle update haproxy-bundle storage-map add id=haproxy-var-lib
        source-dir=/var/lib/haproxy target-dir=/var/lib/haproxy options=rw
      name: Add a bind mount for stats socket in the haproxy bundle
      when: haproxy_stats_exposed.rc == 6
    - name: Set HAProxy public cert volume mount fact
      set_fact:
        haproxy_public_cert_path: /etc/pki/tls/private/overcloud_endpoint.pem
        haproxy_public_tls_enabled: true
    - command: pcs resource bundle update haproxy-bundle storage-map add id=haproxy-cert
        source-dir={{ haproxy_public_cert_path }} target-dir=/var/lib/kolla/config_files/src-tls/{{
        haproxy_public_cert_path }} options=ro
      name: Add a bind mount for public certificate in the haproxy bundle
      when:
      - haproxy_cert_mounted.rc == 6
      - haproxy_public_tls_enabled|bool
    name: Expose HAProxy stats socket on the host and mount TLS cert if needed
  - command: pcs resource bundle update haproxy-bundle container image={{haproxy_image_latest}}
    name: Update the haproxy bundle to use the new container image name
  - name: Enable the haproxy cluster resource
    pacemaker_resource:
      resource: haproxy-bundle
      state: enable
      wait_for_resource: true
    register: output
    retries: 5
    until: output.rc == 0
  name: Update haproxy pcs resource bundle for new container image
  when:
  - step|int == 1
  - is_haproxy_bootstrap_node|bool
  - haproxy_pcs_res|bool
  - haproxy_image_current != haproxy_image_latest
- block:
  - name: set haproxy upgrade node facts in a single-node environment
    set_fact:
      cacheable: false
      haproxy_short_node_names_upgraded: '{{ haproxy_short_node_names }}'
    when: groups['haproxy'] | length <= 1
  - loop: '{{ haproxy_short_node_names | default([]) }}'
    name: set haproxy upgrade node facts from the limit option
    set_fact:
      cacheable: false
      haproxy_short_node_names_upgraded: '{{ haproxy_short_node_names_upgraded|default([])
        + [item.split(''.'')[0]] }}'
    when:
    - groups['haproxy'] | length > 1
    - item.split('.')[0] in ansible_limit.split(':')
  - fail:
      msg: 'You can''t upgrade haproxy without staged upgrade. You need to use the
        limit option in order to do so.

        '
    when: haproxy_short_node_names_upgraded is not defined or haproxy_short_node_names_upgraded
      | length == 0
  - debug:
      msg: Prepare haproxy upgrade for {{ haproxy_short_node_names_upgraded }}
  - include_role:
      name: tripleo_container_rm
    name: remove haproxy init container on upgrade-scaleup to force re-init
    vars:
      tripleo_containers_to_rm:
      - haproxy_init_bundle
    when:
    - haproxy_short_node_names_upgraded | length > 1
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: set.yml
    name: add the haproxy short name to hiera data for the upgrade.
    vars:
      tripleo_upgrade_key: haproxy_short_node_names_override
      tripleo_upgrade_value: '{{haproxy_short_node_names_upgraded}}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: remove.yml
    name: remove the extra hiera data needed for the upgrade.
    vars:
      tripleo_upgrade_key: haproxy_short_node_names_override
    when: haproxy_short_node_names_upgraded | length == haproxy_short_node_names |
      length
  name: Create hiera data to upgrade haproxy in a stepwise manner.
  when:
  - step|int == 1
  - cluster_recreate|bool
- block:
  - name: Get container haproxy image
    set_fact:
      haproxy_image: quay.io/tripleomastercentos9/openstack-haproxy:current-tripleo
      haproxy_image_latest: quay.io/tripleomastercentos9/openstack-haproxy:pcmklatest
  - command: '{{container_cli}} pull {{haproxy_image}}'
    delay: 3
    name: Pull latest haproxy images
    register: result
    retries: 3
    until: result.rc == 0
  - failed_when: false
    name: Get previous haproxy image id
    register: old_haproxy_image_id
    shell: '{{container_cli}} inspect --format ''{{''{{''}}.Id{{''}}''}}'' {{haproxy_image_latest}}'
  - name: Get new haproxy image id
    register: new_haproxy_image_id
    shell: '{{container_cli}} inspect --format ''{{''{{''}}.Id{{''}}''}}'' {{haproxy_image}}'
  - include_role:
      name: tripleo_container_tag
    name: Retag pcmklatest to latest haproxy image
    vars:
      container_image: '{{haproxy_image}}'
      container_image_latest: '{{haproxy_image_latest}}'
    when:
    - old_haproxy_image_id.stdout != new_haproxy_image_id.stdout
  name: Retag the pacemaker image if containerized
  when:
  - step|int == 3
- block:
  - file:
      mode: 1023
      path: /var/tmp
      setype: tmp_t
      state: directory
    name: Reset selinux label on /var/tmp
  name: Anchor for upgrade and update tasks
  when: step|int == 0
- block:
  - include_role:
      name: tripleo_persist
      tasks_from: persist.yml
    name: Persist mysql data
    vars:
      tripleo_persist_dir: /var/lib/mysql
  tags:
  - never
  - system_upgrade
  - system_upgrade_prepare
  vars:
    mysql_upgrade_persist: false
  when:
  - step|int == 3
  - mysql_upgrade_persist
- block:
  - include_role:
      name: tripleo_persist
      tasks_from: restore.yml
    name: Restore mysql data
    vars:
      tripleo_persist_dir: /var/lib/mysql
  tags:
  - never
  - system_upgrade
  - system_upgrade_run
  vars:
    mysql_upgrade_persist: false
  when:
  - step|int == 5
  - mysql_upgrade_persist
- block:
  - failed_when: false
    name: Get galera image id currently used by pacemaker
    register: galera_image_current_res
    shell: pcs resource config galera-bundle | grep -Eo 'image=[^ ]+' | awk -F= '{print
      $2;}'
  - name: Image facts for galera
    set_fact:
      galera_image_current: '{{galera_image_current_res.stdout}}'
      galera_image_latest: quay.io/tripleomastercentos9/openstack-mariadb:pcmklatest
  - import_role:
      name: tripleo_container_tag
    name: Temporarily tag the current galera image id with the upgraded image name
    vars:
      container_image: '{{galera_image_current}}'
      container_image_latest: '{{galera_image_latest}}'
      pull_image: false
    when:
    - galera_image_current != ''
    - galera_image_current != galera_image_latest
  - changed_when: false
    failed_when: false
    name: Check galera cluster resource status
    register: galera_pcs_res_result
    shell: pcs resource config galera-bundle
  - name: Set fact galera_pcs_res
    set_fact:
      galera_pcs_res: '{{galera_pcs_res_result.rc == 0}}'
  - name: set is_mysql_bootstrap_node fact
    set_fact: is_mysql_bootstrap_node={{mysql_short_bootstrap_node_name|lower == ansible_facts['hostname']|lower}}
    tags: common
  name: Prepare switch of galera image name
  when:
  - step|int == 0
- block:
  - name: Disable the galera cluster resource before container upgrade
    pacemaker_resource:
      resource: galera
      state: disable
      wait_for_resource: true
    register: output
    retries: 5
    until: output.rc == 0
  - block:
    - command: cibadmin --query --xpath "//storage-mapping[@id='mysql-log']"
      failed_when: false
      name: Check Mysql logging configuration in pacemaker
      register: mysql_logs_moved
    - block:
      - command: pcs resource bundle update galera-bundle storage-map add id=mysql-log
          source-dir=/var/log/containers/mysql target-dir=/var/log/mysql options=rw
        name: Add a bind mount for logging in the galera bundle
      - command: pcs resource update galera log=/var/log/mysql/mysqld.log
        name: Reconfigure Mysql log file in the galera resource agent
      name: Change Mysql logging configuration in pacemaker
      when: mysql_logs_moved.rc == 6
    name: Move Mysql logging to /var/log/containers
  - command: pcs resource bundle update galera-bundle container image={{galera_image_latest}}
    name: Update the galera bundle to use the new container image name
  - name: Enable the galera cluster resource
    pacemaker_resource:
      resource: galera
      state: enable
      wait_for_resource: true
    register: output
    retries: 5
    until: output.rc == 0
  name: Update galera pcs resource bundle for new container image
  when:
  - step|int == 1
  - is_mysql_bootstrap_node|bool
  - galera_pcs_res|bool
  - galera_image_current != galera_image_latest
- block:
  - name: set mysql upgrade node facts in a single-node environment
    set_fact:
      cacheable: false
      mysql_node_names_upgraded: '{{ mysql_node_names }}'
      mysql_short_node_names_upgraded: '{{ mysql_short_node_names }}'
    when: groups['mysql'] | length <= 1
  - loop: '{{ mysql_node_names | default([]) }}'
    name: set mysql upgrade node facts from the limit option
    set_fact:
      cacheable: false
      mysql_node_names_upgraded: '{{ mysql_node_names_upgraded|default([]) + [item]
        }}'
      mysql_short_node_names_upgraded: '{{ mysql_short_node_names_upgraded|default([])
        + [item.split(''.'')[0]] }}'
    when:
    - groups['mysql'] | length > 1
    - item.split('.')[0] in ansible_limit.split(':')
  - fail:
      msg: 'You can''t upgrade galera without staged upgrade. You need to use the
        limit option in order to do so.

        '
    when: mysql_short_node_names_upgraded is not defined or mysql_short_node_names_upgraded
      | length == 0 or mysql_node_names_upgraded is not defined or mysql_node_names_upgraded
      | length == 0
  - debug:
      msg: Prepare galera upgrade for {{ mysql_short_node_names_upgraded }}
  - include_role:
      name: tripleo_container_rm
    name: remove mysql init container on upgrade-scaleup to force re-init
    vars:
      tripleo_containers_to_rm:
      - mysql_wait_bundle
    when:
    - mysql_short_node_names_upgraded | length > 1
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: set.yml
    name: add the mysql short name to hiera data for the upgrade.
    vars:
      tripleo_upgrade_key: mysql_short_node_names_override
      tripleo_upgrade_value: '{{mysql_short_node_names_upgraded}}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: set.yml
    name: add the mysql long name to hiera data for the upgrade
    vars:
      tripleo_upgrade_key: mysql_node_names_override
      tripleo_upgrade_value: '{{mysql_node_names_upgraded}}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: remove.yml
    loop:
    - mysql_short_node_names_override
    - mysql_node_names_override
    name: remove the extra hiera data needed for the upgrade.
    vars:
      tripleo_upgrade_key: '{{item}}'
    when: mysql_short_node_names_upgraded | length == mysql_node_names | length
  name: Create hiera data to upgrade mysql in a stepwise manner.
  when:
  - step|int == 1
  - cluster_recreate|bool
- block:
  - name: Get container galera image
    set_fact:
      galera_image: quay.io/tripleomastercentos9/openstack-mariadb:current-tripleo
      galera_image_latest: quay.io/tripleomastercentos9/openstack-mariadb:pcmklatest
  - command: '{{container_cli}} pull {{galera_image}}'
    delay: 3
    name: Pull latest galera images
    register: result
    retries: 3
    until: result.rc == 0
  - failed_when: false
    name: Get previous galera image id
    register: old_galera_image_id
    shell: '{{container_cli}} inspect --format ''{{''{{''}}.Id{{''}}''}}'' {{galera_image_latest}}'
  - name: Get new galera image id
    register: new_galera_image_id
    shell: '{{container_cli}} inspect --format ''{{''{{''}}.Id{{''}}''}}'' {{galera_image}}'
  - include_role:
      name: tripleo_container_tag
    name: Retag pcmklatest to latest galera image
    vars:
      container_image: '{{galera_image}}'
      container_image_latest: '{{galera_image_latest}}'
    when:
    - old_galera_image_id.stdout != new_galera_image_id.stdout
  name: Retag the pacemaker image if containerized
  when:
  - step|int == 3
- block:
  - name: Mysql upgrade script
    set_fact:
      mysql_upgrade_script: "kolla_set_configs\nif mysqladmin ping --silent; then\
        \ exit 0; fi\nupgraded_ver=$(cat /var/lib/mysql/mysql_upgrade_info 2>/dev/null\
        \ || true)\nmysql_ver=$(mysql --version | awk -F'[ ,]*' '{print $5}')\nif\
        \ [ \"${upgraded_ver}\" = \"${mysql_ver}\" ]; then\n    echo \"mysql already\
        \ upgraded\"\n    exit 0\nfi\nchown -R mysql:mysql /var/lib/mysql\nchown -R\
        \ mysql:mysql /var/log/mysql\nmysqld_safe --user=mysql --wsrep-provider=none\
        \ --skip-networking --wsrep-on=off --log-error=/var/log/mysql/mysqld-upgrade.log\
        \ &\n\n#!/usr/bin/bash\n\nset -e\n\n# Wait until we know the mysql server\
        \ is up and responding\ntimeout ${DB_MAX_TIMEOUT:-60} /bin/bash -c 'until\
        \ mysqladmin -uroot ping 2>/dev/null; do sleep 1; done'\n\n# After an upgrade,\
        \ make sure that the running mysql had a chance to\n# update its data table\
        \ on disk.\nmysql_upgrade\n\n# Upgrade to 10.3: the default table row format\
        \ changed from COMPACT\n# to DYNAMIC, so upgrade the existing tables.\ncompact_tables=$(mysql\
        \ -se 'SELECT CONCAT(\"`\",TABLE_SCHEMA,\"`.`\",TABLE_NAME,\"`\") FROM information_schema.tables\
        \ WHERE ENGINE = \"InnoDB\" and ROW_FORMAT = \"Compact\";');\nfor i in $compact_tables;\
        \ do echo converting row format of table $i; mysql -e \"ALTER TABLE $i ROW_FORMAT=DYNAMIC;\"\
        ; done;\n\nmysqladmin shutdown"
  - name: Bind mounts for temporary container
    set_fact:
      mysql_upgrade_db_bind_mounts:
      - /etc/hosts:/etc/hosts:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/pki/ca-trust/extracted:/etc/pki/ca-trust/extracted:ro
      - /etc/pki/ca-trust/source/anchors:/etc/pki/ca-trust/source/anchors:ro
      - /etc/pki/tls/certs/ca-bundle.crt:/etc/pki/tls/certs/ca-bundle.crt:ro
      - /etc/pki/tls/certs/ca-bundle.trust.crt:/etc/pki/tls/certs/ca-bundle.trust.crt:ro
      - /etc/pki/tls/cert.pem:/etc/pki/tls/cert.pem:ro
      - /dev/log:/dev/log
      - /etc/puppet:/etc/puppet:ro
      - /var/lib/kolla/config_files/mysql.json:/var/lib/kolla/config_files/config.json:rw,z
      - /var/lib/config-data/puppet-generated/mysql:/var/lib/kolla/config_files/src:ro,z
      - /var/lib/mysql:/var/lib/mysql:rw,z
      - /var/log/containers/mysql:/var/log/mysql:rw,z
  - environment:
      UPGRADE_SCRIPT: '{{ mysql_upgrade_script }}'
    name: Upgrade Mysql database from a temporary container
    shell: '{{ container_cli }} run --rm --log-driver=k8s-file --log-opt path=/var/log/containers/mysql/db-upgrade.log
      \ -u root --net=host -e "KOLLA_CONFIG_STRATEGY=COPY_ALWAYS" -v {{ mysql_upgrade_db_bind_mounts
      | join('' -v '')}} "quay.io/tripleomastercentos9/openstack-mariadb:pcmklatest"
      /bin/bash -ecx "$UPGRADE_SCRIPT"'
  name: Check and upgrade Mysql database after major version upgrade
  when: step|int == 3
- failed_when: false
  name: Remove openstack-nova-compute and python-nova package during upgrade
  package:
    name:
    - openstack-nova-compute
    - python-nova
    state: removed
  when: step|int == 2
- block:
  - file:
      path: /etc/tmpfiles.d/var-run-libvirt.conf
      state: absent
    name: Remove old tmpfiles.d config
  name: nova_libvirt_container_tmpfile_cleanup
  when: step|int == 1
- include_role:
    name: tripleo_nova_migration_target
    tasks_from: upgrade.yaml
  name: nova-migration-target upgrade
  when: step|int == 1
- block:
  - name: check for octavia post-deploy.conf file
    register: octavia_post_deploy_stat
    stat:
      path: /var/lib/config-data/puppet-generated/octavia/etc/octavia/post-deploy.conf
  - file:
      mode: '0755'
      path: /var/lib/config-data/puppet-generated/octavia/etc/octavia/post-deploy.conf
      setype: container_file_t
      state: touch
    name: create an empty post-deploy.conf file if it does not exist
    when:
    - octavia_post_deploy_stat.exists is defined and not octavia_post_deploy_stat.exists
  name: make sure that post-deploy.conf exists before restarting containers on update
    or upgrade
  when: step|int == 5
- block:
  - file:
      path: /etc/tmpfiles.d/var-run-octavia.conf
      state: absent
    name: octavia_api_tmpfile_cleanup
  name: octavia_api_tmpfile_cleanup
  when: step|int == 1
- block:
  - failed_when: false
    name: Get rabbitmq image id currently used by pacemaker
    register: rabbitmq_image_current_res
    shell: pcs resource config rabbitmq-bundle | grep -Eo 'image=[^ ]+' | awk -F=
      '{print $2;}'
  - name: Image facts for rabbitmq
    set_fact:
      rabbitmq_image_current: '{{rabbitmq_image_current_res.stdout}}'
      rabbitmq_image_latest: quay.io/tripleomastercentos9/openstack-rabbitmq:pcmklatest
  - block:
    - import_role:
        name: tripleo_container_tag
      name: Temporarily tag the current rabbitmq image id with the upgraded image
        name
      vars:
        container_image: '{{rabbitmq_image_current}}'
        container_image_latest: '{{rabbitmq_image_latest}}'
        pull_image: false
      when:
      - rabbitmq_image_current != ''
      - rabbitmq_image_current != rabbitmq_image_latest
    name: Prepare the switch to new rabbitmq container image name in pacemaker
  - failed_when: false
    name: Check rabbitmq cluster resource status
    register: rabbitmq_pcs_res_result
    shell: pcs resource config rabbitmq-bundle
  - name: Set fact rabbitmq_pcs_res
    set_fact:
      rabbitmq_pcs_res: '{{rabbitmq_pcs_res_result.rc == 0}}'
  - name: set is_rpc_rabbitmq_bootstrap_node fact
    set_fact: is_rpc_rabbitmq_bootstrap_node={{oslo_messaging_rpc_short_bootstrap_node_name|lower
      == ansible_facts['hostname']|lower}}
  name: Prepare switch of rabbitmq image name
  when:
  - step|int == 0
- block:
  - name: Disable the rabbitmq cluster resource before container upgrade
    pacemaker_resource:
      resource: rabbitmq-bundle
      state: disable
      wait_for_resource: true
    register: output
    retries: 5
    until: output.rc == 0
  - block:
    - command: cibadmin --query --xpath "//storage-mapping[@id='rabbitmq-log']"
      failed_when: false
      name: Check rabbitmq logging configuration in pacemaker
      register: rabbitmq_logs_moved
    - command: pcs resource bundle update rabbitmq-bundle storage-map add id=rabbitmq-log
        source-dir=/var/log/containers/rabbitmq target-dir=/var/log/rabbitmq options=rw
      name: Add a bind mount for logging in the rabbitmq bundle
      when: rabbitmq_logs_moved.rc == 6
    name: Move rabbitmq logging to /var/log/containers
  - command: pcs resource bundle update rabbitmq-bundle container image={{rabbitmq_image_latest}}
    name: Update the rabbitmq bundle to use the new container image name
  - name: Enable the rabbitmq cluster resource
    pacemaker_resource:
      resource: rabbitmq-bundle
      state: enable
      wait_for_resource: true
    register: output
    retries: 5
    until: output.rc == 0
  name: Update rabbitmq-bundle pcs resource bundle for new container image
  when:
  - step|int == 1
  - is_rpc_rabbitmq_bootstrap_node|bool
  - rabbitmq_pcs_res|bool
  - rabbitmq_image_current != rabbitmq_image_latest
- block:
  - name: set oslo_messaging_rpc upgrade node facts in a single-node environment
    set_fact:
      cacheable: false
      oslo_messaging_rpc_node_names_upgraded: '{{ oslo_messaging_rpc_node_names }}'
      oslo_messaging_rpc_short_node_names_upgraded: '{{ oslo_messaging_rpc_short_node_names
        }}'
    when: groups['oslo_messaging_rpc'] | length <= 1
  - loop: '{{ oslo_messaging_rpc_node_names | default([]) }}'
    name: set oslo_messaging_rpc upgrade node facts from the limit option
    set_fact:
      cacheable: false
      oslo_messaging_rpc_node_names_upgraded: '{{ oslo_messaging_rpc_node_names_upgraded|default([])
        + [item] }}'
      oslo_messaging_rpc_short_node_names_upgraded: '{{ oslo_messaging_rpc_short_node_names_upgraded|default([])
        + [item.split(''.'')[0]] }}'
    when:
    - groups['oslo_messaging_rpc'] | length > 1
    - item.split('.')[0] in ansible_limit.split(':')
  - fail:
      msg: 'You can''t upgrade oslo_messaging_rpc without staged upgrade.  You need
        to use the limit option in order to do so.

        '
    when: oslo_messaging_rpc_short_node_names_upgraded is not defined or oslo_messaging_rpc_short_node_names_upgraded
      | length == 0 or oslo_messaging_rpc_node_names_upgraded is not defined or oslo_messaging_rpc_node_names_upgraded
      | length == 0
  - debug:
      msg: Prepare oslo_messaging_rpc upgrade for {{ oslo_messaging_rpc_short_node_names_upgraded
        }}
  - include_role:
      name: tripleo_container_rm
    name: remove rabbitmq init container on upgrade-scaleup to force re-init
    vars:
      tripleo_containers_to_rm:
      - rabbitmq_wait_bundle
    when:
    - oslo_messaging_rpc_short_node_names_upgraded | length > 1
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: set.yml
    name: add the oslo_messaging_rpc short name to hiera data for the upgrade.
    vars:
      tripleo_upgrade_key: oslo_messaging_rpc_short_node_names_override
      tripleo_upgrade_value: '{{oslo_messaging_rpc_short_node_names_upgraded}}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: set.yml
    name: add the oslo_messaging_rpc long name to hiera data for the upgrade
    vars:
      tripleo_upgrade_key: oslo_messaging_rpc_node_names_override
      tripleo_upgrade_value: '{{oslo_messaging_rpc_node_names_upgraded}}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: remove.yml
    loop:
    - oslo_messaging_rpc_short_node_names_override
    - oslo_messaging_rpc_node_names_override
    name: remove the extra hiera data needed for the upgrade.
    vars:
      tripleo_upgrade_key: '{{item}}'
    when: oslo_messaging_rpc_short_node_names_upgraded | length == oslo_messaging_rpc_node_names
      | length
  name: Create hiera data to upgrade oslo messaging rpc in a stepwise manner.
  when:
  - step|int == 1
  - cluster_recreate|bool
- block:
  - name: Get container rabbitmq image
    set_fact:
      rabbitmq_image: quay.io/tripleomastercentos9/openstack-rabbitmq:current-tripleo
      rabbitmq_image_latest: quay.io/tripleomastercentos9/openstack-rabbitmq:pcmklatest
  - command: '{{container_cli}} pull {{rabbitmq_image}}'
    delay: 3
    name: Pull latest rabbitmq images
    register: result
    retries: 3
    until: result.rc == 0
  - failed_when: false
    name: Get previous rabbitmq image id
    register: old_rabbitmq_image_id
    shell: '{{container_cli}} inspect --format ''{{''{{''}}.Id{{''}}''}}'' {{rabbitmq_image_latest}}'
  - name: Get new rabbitmq image id
    register: new_rabbitmq_image_id
    shell: '{{container_cli}} inspect --format ''{{''{{''}}.Id{{''}}''}}'' {{rabbitmq_image}}'
  - include_role:
      name: tripleo_container_tag
    name: Retag pcmklatest to latest rabbitmq image
    vars:
      container_image: '{{rabbitmq_image}}'
      container_image_latest: '{{rabbitmq_image_latest}}'
    when:
    - old_rabbitmq_image_id.stdout != new_rabbitmq_image_id.stdout
  name: Retag the pacemaker image if containerized
  when:
  - step|int == 3
- become: true
  name: pre-check to ensure redis is removed if the service is disabled
  shell: "export CIB_file=/var/lib/pacemaker/cib/cib.xml\nif crm_resource -r redis-bundle\
    \ -q &>/dev/null; then\n  echo \"Redis resource present in pacemaker but disabled\
    \ by default in TripleO\" >&2\n  echo \"Delete the resource in pacemaker or enable\
    \ the redis service before upgrading\" >&2\n  exit 1\nfi\n"
  tags:
  - never
  - system_upgrade
  - system_upgrade_prepare
  when:
  - step|int == 0
  - '"redis" not in enabled_services|list'
- block:
  - become: true
    delegate_to: '{{ mysql_short_bootstrap_node_name }}'
    name: check flag file existence in destination host
    register: tripleo_transfer_flag_stat
    stat:
      path: /var/lib/tripleo/transfer-flags/var-lib-mysql
  - name: Set fact cluster_recreate
    set_fact:
      cluster_recreate: '{{ tripleo_transfer_flag_stat.stat.exists|bool }}'
  - async: 30
    name: Check pacemaker cluster running before upgrade
    pacemaker_cluster: state=online check_and_fail=true
    poll: 4
    tags: validation
    when: not cluster_recreate|bool
  name: upgrade step 0
  when: step|int == 0
- block:
  - name: set pacemaker upgrade node facts in a single-node environment
    set_fact:
      cacheable: false
      pacemaker_short_node_names_upgraded: '{{ pacemaker_short_node_names }}'
    when: groups['pacemaker'] | length <= 1
  - loop: '{{ pacemaker_short_node_names | default([]) }}'
    name: set pacemaker upgrade node facts from the limit option
    set_fact:
      cacheable: false
      pacemaker_short_node_names_upgraded: '{{ pacemaker_short_node_names_upgraded|default([])
        + [item.split(''.'')[0]] }}'
    when:
    - groups['pacemaker'] | length > 1
    - item.split('.')[0] in ansible_limit.split(':')
  - fail:
      msg: 'You can''t upgrade pacemaker without staged upgrade. You need to use the
        limit option in order to do so.

        '
    when: pacemaker_short_node_names_upgraded is not defined or pacemaker_short_node_names_upgraded
      | length == 0
  - debug:
      msg: Prepare pacemaker upgrade for {{ pacemaker_short_node_names_upgraded }}
  - name: set pacemaker node ips fact from the names fact
    set_fact:
      cacheable: false
      pacemaker_node_ips_upgraded: '{{ dict(pacemaker_short_node_names|zip(pacemaker_node_ips))
        | dict2items | selectattr(''key'', ''in'', pacemaker_short_node_names_upgraded)
        | map(attribute=''value'') | list }}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: set.yml
    name: add the pacemaker short name to hiera data for the upgrade.
    vars:
      tripleo_upgrade_key: pacemaker_short_node_names_override
      tripleo_upgrade_value: '{{pacemaker_short_node_names_upgraded}}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: set.yml
    name: add the pacemaker ips to hiera data for the upgrade.
    vars:
      tripleo_upgrade_key: pacemaker_node_ips_override
      tripleo_upgrade_value: '{{pacemaker_node_ips_upgraded}}'
  - include_role:
      name: tripleo_upgrade_hiera
      tasks_from: remove.yml
    loop:
    - pacemaker_short_node_names_override
    - pacemaker_node_ips_override
    name: remove the extra hiera data needed for the upgrade.
    vars:
      tripleo_upgrade_key: '{{item}}'
    when: pacemaker_short_node_names_upgraded | length == pacemaker_short_node_names
      | length
  name: Create hiera data to upgrade pacemaker in a stepwise manner.
  when:
  - step|int == 1
  - cluster_recreate|bool
- block:
  - name: Stop pacemaker cluster
    pacemaker_cluster: state=offline
    when: not cluster_recreate|bool
  name: upgrade step 2
  when: step|int == 2
- block:
  - name: Start pacemaker cluster
    pacemaker_cluster: state=online
    when: not cluster_recreate|bool
  name: upgrade step 4
  when: step|int == 4
- block:
  - lineinfile:
      dest: /etc/hosts
      line: '{{ undercloud_hosts_entries | join('''') }}'
      state: present
    name: Make sure the Undercloud hostname is included in /etc/hosts
    when:
    - undercloud_hosts_entries is defined
  - name: Set container_registry_insecure_registries fact.
    set_fact: {}
  - include_role:
      name: tripleo_podman
      tasks_from: tripleo_podman_install.yml
  name: Run podman install
  when:
  - step|int == 1
- block:
  - name: Check if pcs is present
    register: pcs_stat
    stat:
      path: /usr/sbin/pcs
  - name: Stop pacemaker cluster before stopping all docker containers
    pacemaker_cluster: state=offline
    when: pcs_stat.stat.exists
  - command: /usr/sbin/pcs cluster destroy
    name: Destroy pacemaker cluster
    when: pcs_stat.stat.exists
  name: system_upgrade_prepare step 2
  tags:
  - never
  - system_upgrade
  - system_upgrade_prepare
  when:
  - step|int == 2
- block:
  - name: Ensure redis is uninstalled on container host
    package:
      name: redis
      state: absent
  name: redis_container_puppet_redis_pkg_clean
  when: step|int == 1
- block:
  - file:
      path: /etc/tmpfiles.d/var-run-redis.conf
      state: absent
    name: remove old tmpfiles.d config
  name: redis_container_puppet_tmpfile_cleanup
  when: step|int == 1
- block:
  - command: systemctl is-enabled --quiet snmpd
    failed_when: false
    name: Check if snmpd is enabled
    register: snmpd_enabled_result
  - name: Set fact snmpd_enabled
    set_fact:
      snmpd_enabled: '{{ snmpd_enabled_result.rc == 0 }}'
  when: step|int == 0
- name: Stop snmp service
  service: name=snmpd state=stopped
  when:
  - step|int == 1
  - snmpd_enabled|bool
- block:
  - failed_when: false
    name: Disable tripleo-iptables.service
    register: systemd_tripleo_iptables
    systemd:
      enabled: false
      name: tripleo-iptables.service
      state: stopped
  - file:
      path: /etc/systemd/system/tripleo-iptables.service
      state: absent
    name: Cleanup tripleo-iptables.services
  - failed_when: false
    name: Disable tripleo-ip6tables.service
    register: systemd_tripleo_ip6tables
    systemd:
      enabled: false
      name: tripleo-ip6tables.service
      state: stopped
  - file:
      path: /etc/systemd/system/tripleo-ip6tables.service
      state: absent
    name: Cleanup tripleo-ip6tables.services
  - name: Reload systemd
    systemd:
      daemon_reload: true
    when:
    - (systemd_tripleo_iptables is changed or systemd_tripleo_ip6tables is changed)
  name: Cleanup tripleo-iptables services
  when:
  - (step | int) == 1
- block:
  - args:
      creates: /etc/sysconfig/ip6tables.n-o-upgrade
    name: blank ipv6 rule before activating ipv6 firewall.
    shell: cat /etc/sysconfig/ip6tables > /etc/sysconfig/ip6tables.n-o-upgrade; cat</dev/null>/etc/sysconfig/ip6tables
  - name: cleanup unmanaged rules pushed by iptables-services
    shell: "iptables -C INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT &>/dev/null\
      \ && \\\n  iptables -D INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT\n\
      iptables -C INPUT -p icmp -j ACCEPT &>/dev/null && \\\n  iptables -D INPUT -p\
      \ icmp -j ACCEPT\niptables -C INPUT -i lo -j ACCEPT &>/dev/null && \\\n  iptables\
      \ -D INPUT -i lo -j ACCEPT\niptables -C INPUT -p tcp -m state --state NEW -m\
      \ tcp --dport 22 -j ACCEPT &>/dev/null && \\\n  iptables -D INPUT -p tcp -m\
      \ state --state NEW -m tcp --dport 22 -j ACCEPT\niptables -C INPUT -j REJECT\
      \ --reject-with icmp-host-prohibited &>/dev/null && \\\n  iptables -D INPUT\
      \ -j REJECT --reject-with icmp-host-prohibited\niptables -C FORWARD -j REJECT\
      \ --reject-with icmp-host-prohibited &>/dev/null && \\\n  iptables -D FORWARD\
      \ -j REJECT --reject-with icmp-host-prohibited\n\nsed -i '/^-A INPUT -m state\
      \ --state RELATED,ESTABLISHED -j ACCEPT$/d' /etc/sysconfig/iptables\nsed -i\
      \ '/^-A INPUT -p icmp -j ACCEPT$/d' /etc/sysconfig/iptables\nsed -i '/^-A INPUT\
      \ -i lo -j ACCEPT$/d' /etc/sysconfig/iptables\nsed -i '/^-A INPUT -p tcp -m\
      \ state --state NEW -m tcp --dport 22 -j ACCEPT$/d' /etc/sysconfig/iptables\n\
      sed -i '/^-A INPUT -j REJECT --reject-with icmp-host-prohibited$/d' /etc/sysconfig/iptables\n\
      sed -i '/^-A FORWARD -j REJECT --reject-with icmp-host-prohibited$/d' /etc/sysconfig/iptables\n\
      \nip6tables -C INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT &>/dev/null\
      \ && \\\n  ip6tables -D INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT\n\
      ip6tables -C INPUT -p ipv6-icmp -j ACCEPT &>/dev/null && \\\n  ip6tables -D\
      \ INPUT -p ipv6-icmp -j ACCEPT\nip6tables -C INPUT -i lo -j ACCEPT &>/dev/null\
      \ && \\\n  ip6tables -D INPUT -i lo -j ACCEPT\nip6tables -C INPUT -p tcp -m\
      \ state --state NEW -m tcp --dport 22 -j ACCEPT &>/dev/null && \\\n  ip6tables\
      \ -D INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT\nip6tables\
      \ -C INPUT -d fe80::/64 -p udp -m udp --dport 546 -m state --state NEW -j ACCEPT\
      \ &>/dev/null && \\\n  ip6tables -D INPUT -d fe80::/64 -p udp -m udp --dport\
      \ 546 -m state --state NEW -j ACCEPT\nip6tables -C INPUT -j REJECT --reject-with\
      \ icmp6-adm-prohibited &>/dev/null && \\\n  ip6tables -D INPUT -j REJECT --reject-with\
      \ icmp6-adm-prohibited\nip6tables -C FORWARD -j REJECT --reject-with icmp6-adm-prohibited\
      \ &>/dev/null && \\\n  ip6tables -D FORWARD -j REJECT --reject-with icmp6-adm-prohibited\n\
      \nsed -i '/^-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT$/d' /etc/sysconfig/ip6tables\n\
      sed -i '/^-A INPUT -p ipv6-icmp -j ACCEPT$/d' /etc/sysconfig/ip6tables\nsed\
      \ -i '/^-A INPUT -i lo -j ACCEPT$/d' /etc/sysconfig/ip6tables\nsed -i '/^-A\
      \ INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT$/d' /etc/sysconfig/ip6tables\n\
      sed -i '/^-A INPUT -d fe80::\\/64 -p udp -m udp --dport 546 -m state --state\
      \ NEW -j ACCEPT$/d' /etc/sysconfig/ip6tables\nsed -i '/^-A INPUT -j REJECT --reject-with\
      \ icmp6-adm-prohibited$/d' /etc/sysconfig/ip6tables\nsed -i '/^-A FORWARD -j\
      \ REJECT --reject-with icmp6-adm-prohibited$/d' /etc/sysconfig/ip6tables"
  when:
  - (step | int) == 3
- name: Gather missing facts
  setup:
    gather_subset:
    - '!all'
    - '!min'
    - distribution
  tags:
  - always
  when: ansible_facts['distribution'] is not defined or ansible_facts['distribution_major_version']
    is not defined
- name: Set leapp facts
  set_fact:
    upgrade_leapp_command_options: ''
    upgrade_leapp_debug: true
    upgrade_leapp_devel_skip: ''
    upgrade_leapp_enabled: "{{ _upgradeLeappEnabled | bool and\n   ansible_facts['distribution']\
      \ == 'RedHat' and\n   ansible_facts['distribution_major_version'] is version('7',\
      \ '==') }}"
    upgrade_leapp_post_reboot_delay: 120
    upgrade_leapp_reboot_timeout: 3600
  tags:
  - always
  vars:
    _upgradeLeappEnabled: false
- block:
  - name: remove all OpenStack packages
    shell: "yum -y remove *el7ost* \\\n  mariadb-server* -- \\\n  -*openvswitch* \\\
      \n  -python2-babel \\\n  -python2-dateutil \\\n  -python2-ipaddress \\\n  -python2-jinja2\
      \ \\\n  -python2-markupsafe \\\n  -python2-six\n"
  - name: install leapp
    package:
      name: leapp
      state: latest
  - lineinfile:
      line: '{{ item }}'
      path: /etc/leapp/transaction/to_remove
    loop: '{{ pkg_to_remove }}'
    name: add packages into Leapp's to_remove file
    vars:
      pkg_to_remove: []
  - lineinfile:
      line: '{{ item }}'
      path: /etc/leapp/transaction/to_install
    loop: '{{ pkg_to_install }}'
    name: add packages into Leapp's to_install file
    vars:
      pkg_to_install: []
  - name: check sshd_config file
    register: sshd_config_result
    stat:
      path: /etc/ssh/sshd_config
  - lineinfile:
      line: PermitRootLogin without-password
      path: /etc/ssh/sshd_config
      regexp: ^(# *)?PermitRootLogin
    name: add PermitRootLogin option for leapp
  name: system_upgrade_prepare step 3
  tags:
  - never
  - system_upgrade
  - system_upgrade_prepare
  when:
  - step|int == 3
  - upgrade_leapp_enabled
- block:
  - name: run leapp upgrade (download packages)
    shell: '{% if upgrade_leapp_devel_skip|default(false) %}{{ upgrade_leapp_devel_skip
      }}{% endif %} leapp upgrade {% if upgrade_leapp_debug|default(true) %}--debug{%
      endif %} {% if upgrade_leapp_command_options|default(false) %}{{ upgrade_leapp_command_options
      }}{% endif %}

      '
    when: upgrade_leapp_enabled
  name: system_upgrade_prepare step 4
  tags:
  - never
  - system_upgrade
  - system_upgrade_prepare
  when: step|int == 4
- block:
  - name: reboot to perform the upgrade
    reboot:
      post_reboot_delay: '{{ upgrade_leapp_post_reboot_delay }}'
      reboot_timeout: '{{upgrade_leapp_reboot_timeout}}'
      test_command: source /etc/os-release; [ "${VERSION_ID%.*}" -ge "8" ] && systemctl
        is-system-running | grep -qE "running|degraded" || exit 1
  name: system_upgrade_run step 4
  tags:
  - never
  - system_upgrade
  - system_upgrade_run
  - system_upgrade_reboot
  when:
  - step|int == 4
  - upgrade_leapp_enabled
- block:
  - name: Run UpgradeInitCommand
    shell: '#!/bin/bash


      if [[ -f /etc/resolv.conf.save ]] ; then rm /etc/resolv.conf.save; fi


      '
  - name: Run UpgradeInitCommonCommand
    shell: '#!/bin/bash


      '
  - dnf:
      name: '@{{ item.module }}:{{ item.stream }}/{{ item.profile|default(''common'')
        }}'
      state: present
    loop: '{{ dnf_module_list|list }}'
    name: Ensure DNF modules have the right stream
    vars:
      dnf_module_list: []
    when:
    - dnf_module_list|length > 0
    - item.distribution_version is defined
    - ansible_facts['distribution_major_version'] is version(item.distribution_version,
      '==')
  - name: Ensure TripleO prerequisite packages are installed
    package:
      name:
      - jq
      - lvm2
      - net-snmp
      - openstack-selinux
      - os-net-config
      - puppet-tripleo
      - python3-heat-agent*
      - python3-openstackclient
      - rsync
      state: present
    when: ansible_facts['distribution_major_version'] is version('8', '==')
  name: Package and repo update tasks
  when: step|int == 0
- check_mode: false
  command: /usr/bin/rpm -q libvirt-daemon
  failed_when: false
  name: check if libvirt is installed
  register: libvirt_installed
  when: step|int == 0
- loop:
  - libvirtd.service
  - virtlogd.socket
  name: make sure libvirt services are disabled and masked
  service:
    daemon_reload: true
    enabled: false
    masked: true
    name: '{{ item }}'
    state: stopped
  when:
  - step|int == 0
  - libvirt_installed.rc == 0
- name: Special treatment for OpenvSwitch
  register: ovs_upgrade
  tripleo_ovs_upgrade: null
  when:
  - step|int == 2
- name: Always ensure the openvswitch service is enabled and running after upgrades
  service:
    enabled: true
    name: openvswitch
    state: started
  when:
  - step|int == 2
  - ovs_upgrade.changed|bool
- name: Install libibverbs (https://bugs.launchpad.net/tripleo/+bug/1817743)
  package:
    name: libibverbs
    state: installed
  when: step|int == 2
- name: Check for os-net-config upgrade
  register: os_net_config_need_upgrade
  shell: yum check-upgrade | awk '/os-net-config/{print}'
  when: step|int == 3
- name: Check that os-net-config has configuration
  register: stat_config_json
  stat:
    get_attributes: false
    get_checksum: false
    get_mime: false
    path: /etc/os-net-config/config.json
  when: step|int == 3
- block:
  - name: Upgrade os-net-config
    package: name=os-net-config state=latest
  - changed_when: os_net_config_upgrade.rc == 2
    command: os-net-config --no-activate -c /etc/os-net-config/config.json -v --detailed-exit-codes
    failed_when: os_net_config_upgrade.rc not in [0,2]
    name: take new os-net-config parameters into account now
    register: os_net_config_upgrade
  when:
  - step|int == 3
  - os_net_config_need_upgrade.stdout
  - stat_config_json.stat.exists
- name: Update all packages
  vars:
    skip_package_update: false
  when:
  - step|int == 3
  - not skip_package_update|bool
  yum:
    exclude: ansible
    name: '*'
    state: latest
